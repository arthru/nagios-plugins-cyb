#!/usr/bin/perl
#
# Copyright (C) 2013 Cyril Bouthors <cyril@boutho.rs>
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.
#

use constant;
# Only use when debugging because it can lead to 50% performance loss
# use diagnostics;
use integer;
use sigtrap  qw(SEGV BUS);
use strict   qw(subs vars refs);
use subs     qw(afunc blurfl);
use warnings qw(all);
use sort     qw(stable _quicksort _mergesort);
use Config::Simple;
use Net::Google::SafeBrowsing2;
use Net::Google::SafeBrowsing2::Sqlite;
use Fcntl ':flock';
use File::Copy qw(copy);

# Lock
my $lock_file = '/var/lock/nagios-plugins-cyb-update-gsb-db';

open(my $fh, '>>', $lock_file)
    or die "Could not open '$lock_file' - $!";

flock($fh, LOCK_EX|LOCK_NB)
    or exit;

# Make a copy of the database
my $db_file = '/var/lib/nagios-plugins-cyb/google-safe-browsing.sqlite';
my $tmp_file = $db_file . '.tmp';

if (-f $db_file)
{
    copy($db_file, $tmp_file)
	or die $!;
}

# Load configuration file
my $cfg = new Config::Simple('/etc/nagios-plugins/config/safe-browsing.conf')
    or die();

# Define database storage
my $storage = Net::Google::SafeBrowsing2::Sqlite->new(file => $tmp_file);

# Define Google Safe Browsing API
my $gsb = Net::Google::SafeBrowsing2->new(
    key     => $cfg->param('GoogleSafeBrowsingAPIKey'),
    storage => $storage,
    );

# Update database
$gsb->update();

# Close storage
$storage->close();

rename($tmp_file, $db_file)
    or die $!;

# Unlock
close($fh)
    or die "Could not write '$lock_file' - $!";
